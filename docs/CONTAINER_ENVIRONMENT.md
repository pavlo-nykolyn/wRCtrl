# wRCtrl in a container

This features enables the creation of a Docker container and the execution of wRCtrl through a wrapper script.
Such instance can be launched as a cron job.
Though, the added overhead of creating this container may not suit the needs of everyone.

The current configuration includes a Dockerfile and a start script.

In regards to the Dockerfile, whilst I tried to make it as unconstrained as possible (in terms of dependencies),
certain limitations that I've put on the build process forced the use of specific dependencies. In particular:

- *stdbool.h*, whilst available on most (if not all) C99 implementations, usually gets installed within the *include* sub-directory
  found in the gcc version directory (I've used **/usr/lib/gcc/x86_64-linux-gnu/12/include** within VPATH in the makefile);
- the source image is ubuntu. It is necessary to indicate 22.04 (jammy) as the image version. Newer releases may be
  viable but the dependencies are to be changed;
- if a specific version of the gcc compilation system gets installed within the image, /bin gets only a gcc-12 symbolic
  link to a binary file placed in the directory hierarchy of the library. I had to create a symbolic link named gcc
  to maintain compatibility with the makefile I had created in the past;

two environment variables are available:

| name | description |
| --- | --- |
| RELAY\_ARRAY\_CONFIGURATION | the format of the configuration is **\<ip-address\>;\[\<port\>\];\<model\>** |
| IDS | a sequence of relay identifiers. Each identifier shall belong to the interval \[1, 8\]. The format of the sequence is **\<id\>{ \<id\>}** |

- \<ip-address\> is the IPv4 address of the web relay network interface;
- \<port\> currently used only by the NC800;
- \<model\> indicates the web relay model {*KMTronic_wr*, *NC800*};

> [!IMPORTANT]
> both environment variables are to be defined. The Dockerfile does not provide default values

## how to build the image

(older version of the Docker daemon may not use BuildKit)

```bash
docker buildx build --file Dockerfile --build-arg 'image_version=22.04' --output 'type=image,name=wrctrl_controller,push=false' .
```

## how to run the image

```bash
docker buildx build --detach --name 'wrctrl_controller' --mount 'type=bind,src=<source>,dst=/wRCtrl/logs' wrctrl_controller
```

the bind mount is necessary to store the log information generated by the execution of the controller. It cannot be read-only, as
the container shall be able to both create and update the file *relay_controller.txt* within it.

The entry point is *start_controller.sh*. I have borrowed most of my previous implementation of *wRCtrl_wrapper*. But, given that
a sequence of relay identifiers can now be sourced, it gets processed only after the configuration options have been created.

## how to create and run CronJobs in a Kubernetes cluster

The CronJobs will be based on the image created from the provided Dockerfile (the image name shall reference a registry). In order
to create a CronJob, two Kubernetes objects have to exist first:

- the *utility-objects* namespace (declared by **k8s-namespace-utility-objects.yaml**);

```bash
kubectl apply --filename k8s-namespace-utility-objects.yaml
```

- the configMap related to the CronJob. I have provided a template declaration (**k8s-config-map-template.yaml**). The user needs to
  define the following fields: *name* (the name of the configMap), *relay-array-configuration* (identical to RELAY\_ARRAY\_CONFIGURATION)
  and ids (identical to IDS);

the template declaration for the CronJob is **k8s-wrctrl-cjob-template**. The following fields need to be defined:

- *metadata.name* the name of the CronJob;
- *spec.schedule* the cron specification;
- *spec.jobTemplate.spec.template.spec.volumes.[0].hostPath.path* the host path that will contain the log data produced during the cron job execution;
- *spec.jobTemplate.spec.template.spec.containers.[0].env.[0].valueFrom.configMapKeyRef.name* the configMap name that defines the *relay-array-configuration* key;
- *spec.jobTemplate.spec.template.spec.containers.[0].env.[1].valueFrom.configMapKeyRef.name* the configMap name that defines the *ids* key;

the complete declarations for both the configMap and the CronJob can be renamed before ```kubectl apply``` gets invoked.
